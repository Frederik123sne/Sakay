<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ride History</title>
  <link rel="stylesheet" href="/views/driver/css/driver.css" />
  <link rel="stylesheet" href="/views/driver/css/large-screen.css">
  <link rel="stylesheet" href="/views/driver/css/small-screen.css">
  <link rel="icon" type="image/x-icon" href="/views/assets/Logo.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>

<body>
  <!-- SIDE NAVIGATION -->
  <div class="sidebar">
    <div class="logo-container">
      <img src="/views/assets/SAKAY BRAVO LOGO_DARK YELLOW.png" class="app-logo" alt="Logo" />
    </div>

    <a href="/driver/home">Home</a>
    <a href="/driver/rides">Ride Information</a>
    <a href="/driver/requirements">Requirements</a>
    <a class="active" href="/driver/history">History</a>

    <div class="contact">
      <a href="/driver/contact" class="contact">Contact Us</a>
    </div>
  </div>

  <!-- TOP NAVIGATION -->
  <header class="top-nav">
    <div class="nav-left">
      <h1 class="nav-title">History</h1>
      <h2 class="sub-title" id="welcomeMessage">
        Monitor and track your transactions
      </h2>
    </div>
    <div class="nav-right">
      <div class="icon notification">
        <img src="/views/assets/Notification Icon.png" alt="Notifications" />
      </div>
      <div class="profile-dropdown-container">
        <div class="profile" id="profileBtn">
          <img src="/views/assets/Profile Icon.png" alt="Profile" id="profileIcon" />
        </div>
        <!-- Dropdown Menu -->
        <div class="profile-dropdown" id="profileDropdown">
          <div class="dropdown-header">
            <img src="/views/assets/Profile Icon.png" alt="Profile Picture" class="dropdown-profile-pic"
              id="dropdownProfilePic" />
            <div class="dropdown-user-info">
              <h4 id="userName">Loading...</h4>
              <p id="userEmail">Loading...</p>
              <span class="driver-badge">Driver</span>
            </div>
          </div>
          <div class="dropdown-divider"></div>
          <a href="/driver/profile" class="dropdown-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <span>My Profile</span>
          </a>
          <a href="/driver/rides" class="dropdown-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 17h14v-4H5v4z"></path>
              <path d="M5 11h4"></path>
              <circle cx="7" cy="17" r="2"></circle>
              <circle cx="17" cy="17" r="2"></circle>
            </svg>
            <span>My Rides</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item logout-item" id="logoutBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>Log Out</span>
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    <!-- Statistics Cards -->
    <div class="tabs-container">
      <div class="row">
        <div class="column">
          <div class="card">
            <h3 class="card-header">Rides Completed</h3>
            <p class="number">-</p>
          </div>
        </div>
        <div class="column">
          <div class="card">
            <h3 class="card-header">Total Distance Traveled</h3>
            <p class="number">-</p>
          </div>
        </div>
        <div class="column">
          <div class="card">
            <h3 class="card-header">Total Earnings</h3>
            <p class="number">-</p>
          </div>
        </div>
        <div class="column">
          <div class="card">
            <h3 class="card-header">Average Rating</h3>
            <p class="number">-</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="filters">
      <div class="filter-left">
        <input type="text" class="filter-search-bar" placeholder="Search by name, date, etc..." />
        <button class="button sort-order-button" id="sortOrderBtn">
          <span class="sort-icon">-</span>
          <span class="sort-text">ASCENDING</span>
        </button>
      </div>
    </div>

    <!-- Transaction Table -->
    <div class="table-of-transactions" id="tableContainer">
      <table class="transactions-information">
        <thead>
          <tr>
            <th>Reference</th>
            <th>Date</th>
            <th>Pickup</th>
            <th>Dropoff</th>
            <th>Passenger</th>
            <th>Status</th>
            <th>Payment Method</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="8" style="text-align: center; padding: 20px;">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- No History Fallback -->
    <div id="noHistoryContainer" style="display: none; text-align: center; padding: 60px 20px;">
      <h3 style="color: #333; font-size: 18px; margin-bottom: 10px;">No Ride History Yet</h3>
      <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
        You haven't completed any rides yet. Start creating rides to build your history!
      </p>
      <a href="/driver/rides"
        style="display: inline-block; padding: 10px 20px; background: #4CAF50; color: white; text-decoration: none; border-radius: 5px; font-size: 14px;">
        Create a Ride
      </a>
    </div>

    <div class="pagination-container">
      <div class="pagination-info">
        Showing <strong>1</strong> to <strong>3</strong> of
        <strong>3</strong> transactions
      </div>

      <div class="pagination-buttons">
        <button class="page-btn">&#8249;</button>
        <button class="page-btn active">1</button>
        <button class="page-btn">&#8250;</button>
      </div>
    </div>
  </div>

  <!-- Load API Service -->
  <script src="/js/api.js"></script>

  <script>
    let currentSortOrder = 'DESC';
    let allRides = [];

    document.addEventListener("DOMContentLoaded", async function () {
      console.log("Driver history page loading...");

      const api = window.api;

      try {
        // Load profile
        const profileResp = await api.getDriverProfile();
        if (profileResp.success) {
          const profile = profileResp.data;
          document.getElementById("userName").textContent = `${profile.first_name} ${profile.last_name}`;
          document.getElementById("userEmail").textContent = profile.email;
          if (profile.profile_pic) {
            const photoPath = `/${profile.profile_pic}`;
            document.getElementById("profileIcon").src = photoPath;
            document.getElementById("dropdownProfilePic").src = photoPath;
          }
        }

        // Load history
        const historyResp = await api.getRideHistory('DESC', 100, 0);
        console.log('History response:', historyResp);
        if (historyResp.success) {
          allRides = historyResp.data.rides || [];
          const stats = historyResp.data.stats || {};

          console.log('All rides:', allRides);
          console.log('Stats:', stats);

          // Populate stats with safe type conversion
          document.querySelector('.card:nth-child(1) .number').textContent = parseFloat(stats.total_rides) || '0';
          document.querySelector('.card:nth-child(2) .number').textContent = (parseFloat(stats.total_distance) || 0).toFixed(1) + ' km';
          document.querySelector('.card:nth-child(3) .number').textContent = '₱' + (parseFloat(stats.total_earnings) || 0).toFixed(2);
          document.querySelector('.card:nth-child(4) .number').textContent = (parseFloat(stats.average_rating) || 0).toFixed(1);

          // Populate table
          populateTable(allRides);
        } else {
          console.error('History response failed:', historyResp.message);
          populateTable([]);
        }
      } catch (error) {
        console.error("Error loading history:", error);
        // Show empty state on error
        populateTable([]);
      }

      // Logout handler
      document.getElementById("logoutBtn").addEventListener("click", async (e) => {
        e.preventDefault();
        try {
          await api.logout();
          localStorage.removeItem("auth_token");
          window.location.href = "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
        } catch (error) {
          console.error("Logout error:", error);
          window.location.href = "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
        }
      });

      // Profile dropdown toggle
      const profileBtn = document.getElementById("profileBtn");
      const profileDropdown = document.getElementById("profileDropdown");
      if (profileBtn && profileDropdown) {
        profileBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          profileDropdown.classList.toggle("show");
        });
        document.addEventListener("click", function (e) {
          if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
            profileDropdown.classList.remove("show");
          }
        });
      }

      // Sort order button
      document.getElementById('sortOrderBtn').addEventListener('click', function () {
        currentSortOrder = currentSortOrder === 'DESC' ? 'ASC' : 'DESC';
        document.querySelector('.sort-text').textContent = currentSortOrder;
        allRides.sort((a, b) => {
          const dateA = new Date(a.departure_time);
          const dateB = new Date(b.departure_time);
          return currentSortOrder === 'DESC' ? dateB - dateA : dateA - dateB;
        });
        populateTable(allRides);
      });

      // Search functionality
      document.querySelector('.filter-search-bar').addEventListener('input', function (e) {
        const query = e.target.value.toLowerCase();
        const filtered = allRides.filter(ride =>
          (ride.passenger_first_name + ' ' + ride.passenger_last_name).toLowerCase().includes(query) ||
          ride.origin.toLowerCase().includes(query) ||
          ride.destination.toLowerCase().includes(query) ||
          ride.bookingID?.toLowerCase().includes(query)
        );
        populateTable(filtered);
      });
    });

    function populateTable(rides) {
      const tbody = document.querySelector('.transactions-information tbody');
      const tableContainer = document.getElementById('tableContainer');
      const noHistoryContainer = document.getElementById('noHistoryContainer');

      if (rides.length === 0) {
        tableContainer.style.display = 'none';
        noHistoryContainer.style.display = 'block';
        return;
      }

      tableContainer.style.display = 'block';
      noHistoryContainer.style.display = 'none';
      tbody.innerHTML = '';

      rides.forEach(ride => {
        const row = document.createElement('tr');
        const passengerName = ride.passenger_first_name ? `${ride.passenger_first_name} ${ride.passenger_last_name}` : 'No booking';
        const paymentMethod = ride.payment_method || 'N/A';
        const amount = ride.total_fare ? '₱' + ride.total_fare.toFixed(2) : 'N/A';
        const status = ride.payment_status === 'completed' ? 'Paid' : (ride.payment_status || 'Pending');
        const dateStr = new Date(ride.departure_time).toLocaleString();

        row.innerHTML = `
          <td>${ride.bookingID || ride.rideID}</td>
          <td>${dateStr}</td>
          <td>${ride.origin || 'N/A'}</td>
          <td>${ride.destination || 'N/A'}</td>
          <td>${passengerName}</td>
          <td>${status}</td>
          <td>${paymentMethod}</td>
          <td>${amount}</td>
        `;
        tbody.appendChild(row);
      });

      // Update pagination
      document.querySelector('.pagination-info').innerHTML =
        `Showing <strong>1</strong> to <strong>${Math.min(rides.length, 10)}</strong> of <strong>${rides.length}</strong> transactions`;
    }
  </script>
</body>

</html>