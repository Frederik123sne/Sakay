<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SAKAY BRAVO - Driver Dashboard</title>
  <link rel="stylesheet" href="/views/driver/css/driver.css" />
  <link rel="icon" type="image/x-icon" href="/views/assets/Logo.png">
</head>

<body>
  <!-- SIDE NAVIGATION -->
  <div class="sidebar">
    <div class="logo-container">
      <img src="/views/assets/SAKAY BRAVO LOGO_DARK YELLOW.png" class="app-logo" alt="Logo" />
    </div>
    <a class="active" href="/driver/home">Home</a>
    <a href="/driver/rides">Ride Information</a>
    <a href="/driver/requirements">Requirements</a>
    <a href="/driver/history">History</a>
    <div class="contact">
      <a href="/driver/contact" class="contact">Contact Us</a>
    </div>
  </div>

  <!-- TOP NAVIGATION -->
  <header class="top-nav">
    <div class="nav-left">
      <h1 class="nav-title">Dashboard</h1>
      <h2 class="sub-title" id="welcomeMessage">Welcome back, Driver!</h2>
    </div>
    <div class="nav-right">
      <div class="icon notification">
        <img src="/views/assets/Notification Icon.png" alt="Notifications" />
      </div>
      <div class="profile-dropdown-container">
        <div class="profile" id="profileBtn">
          <img src="/views/assets/Profile Icon.png" alt="Profile" id="profileIcon" />
        </div>
        <!-- Dropdown Menu -->
        <div class="profile-dropdown" id="profileDropdown">
          <div class="dropdown-header">
            <img src="/views/assets/Profile Icon.png" alt="Profile Picture" class="dropdown-profile-pic"
              id="dropdownProfilePic" />
            <div class="dropdown-user-info">
              <h4 id="userName">Loading...</h4>
              <p id="userEmail">Loading...</p>
              <span class="driver-badge">Driver</span>
            </div>
          </div>
          <div class="dropdown-divider"></div>
          <a href="/driver/profile" class="dropdown-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <span>My Profile</span>
          </a>
          <a href="/driver/rides" class="dropdown-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 17h14v-4H5v4z"></path>
              <path d="M5 11h4"></path>
              <circle cx="7" cy="17" r="2"></circle>
              <circle cx="17" cy="17" r="2"></circle>
            </svg>
            <span>My Rides</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item logout-item" id="logoutBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>Log Out</span>
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    <section class="highlights-section">
      <div class="section-title">How Can it Help?</div>
      <div class="features-grid driver-features">
        <div class="feature-card driver-card">
          <div class="feature-image">
            <img src="/views/assets/post.png" alt="Post" />
          </div>
          <h3>POST</h3>
          <p>Drivers create a ride offer by setting their route, time, and available seats.</p>
        </div>
        <div class="feature-card driver-card">
          <div class="feature-image">
            <img src="/views/assets/accept.png" alt="Accept" />
          </div>
          <h3>ACCEPT</h3>
          <p>Drivers can review passenger requests and confirm who joins their trip.</p>
        </div>
        <div class="feature-card driver-card">
          <div class="feature-image">
            <img src="/views/assets/earn.png" alt="Earn" />
          </div>
          <h3>EARN</h3>
          <p>Drivers complete rides, earn from their trips, and build a trusted driver reputation.</p>
        </div>
      </div>
    </section>
  </main>

  <!-- Load API Service -->
  <script src="/js/api.js"></script>

  <!-- Driver Profile Script - COPIED FROM PASSENGER -->
  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      console.log('ðŸš— Driver dashboard loading...');
      console.log('APIService available:', typeof window.api);

      // Check for token
      const tokenCookie = document.cookie.split(';').find(c => c.trim().startsWith('auth_token='));
      const tokenLocalStorage = localStorage.getItem('auth_token');
      console.log('Token in cookie:', tokenCookie ? '' : '');
      console.log('Token in localStorage:', tokenLocalStorage ? '' : '');

      // Use the global api instance
      const api = window.api;

      try {
        console.log('ðŸ“¡ Fetching driver profile...');

        const response = await api.getDriverProfile();

        if (response.success) {
          const profile = response.data;
          console.log('Profile loaded:', profile);

          // Update welcome message
          document.getElementById('welcomeMessage').textContent = `Welcome back, ${profile.first_name}!`;

          // Update dropdown user info
          document.getElementById('userName').textContent = `${profile.first_name} ${profile.last_name}`;
          document.getElementById('userEmail').textContent = profile.email;

          // FIXED: Update profile photos - database already has full path
          if (profile.profile_pic) {
            // Database stores: "uploads/profiles/D001_timestamp.png"
            // Just add leading slash
            const photoPath = `/${profile.profile_pic}`;

            console.log('ðŸ“· Profile pic path:', photoPath);

            document.getElementById('profileIcon').src = photoPath;
            document.getElementById('dropdownProfilePic').src = photoPath;
          }
        } else {
          console.error('Failed to load profile:', response);
          alert('Failed to load profile. Please login again.');
          window.location.href = 'http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php';
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        alert('Authentication error: ' + error.message + '\n\nPlease login again.');
        window.location.href = 'http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php';
      }

      // Logout handler
      document.getElementById('logoutBtn').addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          await api.logout();
          localStorage.removeItem('auth_token');
          window.location.href = 'http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php';
        } catch (error) {
          console.error('Logout error:', error);
          localStorage.removeItem('auth_token');
          window.location.href = 'http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php';
        }
      });

      // Profile dropdown toggle
      const profileBtn = document.getElementById('profileBtn');
      const profileDropdown = document.getElementById('profileDropdown');

      if (profileBtn && profileDropdown) {
        profileBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          profileDropdown.classList.toggle('show');
        });

        document.addEventListener('click', function (e) {
          if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
            profileDropdown.classList.remove('show');
          }
        });
      }
    });
  </script>
</body>

</html>