<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contact Us - Driver</title>
  <link rel="stylesheet" href="/views/driver/css/driver.css" />
  <link rel="stylesheet" href="/views/driver/css/small-screen.css" />
  <link rel="stylesheet" href="/views/driver/css/large-screen.css" />
  <link rel="icon" type="image/x-icon" href="/views/assets/Logo.png" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body>
  <!-- SIDE NAVIGATION -->
  <div class="sidebar">
    <div class="logo-container">
      <img src="/views/assets/SAKAY BRAVO LOGO_DARK YELLOW.png" class="app-logo" alt="Logo" />
    </div>

    <a href="/driver/home">Home</a>
    <a href="/driver/rides">Ride Information</a>
    <a href="/driver/requirements">Requirements</a>
    <a href="/driver/history">History</a>

    <div class="contact">
      <a class="active" href="/driver/contact">Contact Us</a>
    </div>
  </div>

  <!-- TOP NAVIGATION -->
  <header class="top-nav">
    <div class="nav-left">
      <h1 class="nav-title">Contact Us</h1>
      <h2 class="sub-title" id="welcomeMessage">Welcome to Sakay Bravo!</h2>
    </div>
    <div class="nav-right">
      <div class="icon notification">
        <img src="/views/assets/Notification Icon.png" alt="Notifications" />
      </div>
      <div class="profile-dropdown-container">
        <div class="profile" id="profileBtn">
          <img src="/views/assets/Profile Icon.png" alt="Profile" id="profileIcon" />
        </div>
        <!-- Dropdown Menu -->
        <div class="profile-dropdown" id="profileDropdown">
          <div class="dropdown-header">
            <img src="/views/assets/Profile Icon.png" alt="Profile Picture" class="dropdown-profile-pic"
              id="dropdownProfilePic" />
            <div class="dropdown-user-info">
              <h4 id="userName">Loading...</h4>
              <p id="userEmail">Loading...</p>
              <span class="driver-badge">Driver</span>
            </div>
          </div>
          <div class="dropdown-divider"></div>
          <a href="/driver/profile" class="dropdown-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <span>My Profile</span>
          </a>
          <a href="/driver/rides" class="dropdown-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 17h14v-4H5v4z"></path>
              <path d="M5 11h4"></path>
              <circle cx="7" cy="17" r="2"></circle>
              <circle cx="17" cy="17" r="2"></circle>
            </svg>
            <span>My Rides</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item logout-item" id="logoutBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>Log Out</span>
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN CONTACT LAYOUT -->
  <div class="contact-wrapper">
    <div class="contact-container">
      <!-- LEFT SIDE – FORM -->
      <div class="contact-form">
        <div id="formMessage" class="form-message"></div>
        
        <div class="form-row">
          <input type="text" id="contactName" placeholder="Name" required />
          <input type="email" id="contactEmail" placeholder="Email" required />
        </div>

        <textarea id="contactMessage" placeholder="Message" rows="6" required></textarea>

        <div class="contact-buttons">
          <button class="btn-send" id="btnSend">SEND</button>
          <button class="btn-reset" id="btnReset">RESET</button>
        </div>
      </div>

      <!-- RIGHT SIDE – CONTACT DETAILS -->
      <div class="contact-info">
        <div class="info-section">
          <div class="info-title">Mailing Address</div>
          <p>
            Sakay Bravo<br />
            Bakakeng, 2600<br />
            Baguio City, Philippines
          </p>
        </div>

        <div class="info-section">
          <div class="info-title">Email</div>
          <a href="mailto:sakaybravo@gmail.com">sakaybravo@gmail.com</a>
        </div>

        <div class="info-section">
          <div class="info-title">Phone</div>
          <p>(000) 555-0000</p>
        </div>

        <div class="info-section">
          <div class="info-title">Socials</div>
          <div class="social-icons">
            <i class="fab fa-facebook-f"></i>
            <i class="fab fa-twitter"></i>
            <i class="fab fa-instagram"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Load API Service -->
  <script src="/js/api.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      console.log("Driver contact page loading...");

      // Use the global api instance
      const api = window.api;

      // Profile loading code
      try {
        console.log("Fetching DRIVER profile...");
        const response = await api.getDriverProfile();

        if (response.success) {
          const profile = response.data;
          console.log("Driver profile loaded:", profile);

          // Update welcome message
          document.getElementById("welcomeMessage").textContent = `Welcome, ${profile.first_name}!`;

          // Update dropdown user info
          document.getElementById("userName").textContent = `${profile.first_name} ${profile.last_name}`;
          document.getElementById("userEmail").textContent = profile.email;

          // Pre-fill contact form with user info
          document.getElementById("contactName").value = `${profile.first_name} ${profile.last_name}`;
          document.getElementById("contactEmail").value = profile.email;

          // Update profile photos
          if (profile.profile_pic) {
            const photoPath = `/${profile.profile_pic}`;
            document.getElementById("profileIcon").src = photoPath;
            document.getElementById("dropdownProfilePic").src = photoPath;
          }
        }
      } catch (error) {
        console.error("Error loading driver profile:", error);
      }

      // Contact Form Handling
      const btnSend = document.getElementById("btnSend");
      const btnReset = document.getElementById("btnReset");
      const formMessage = document.getElementById("formMessage");
      const contactName = document.getElementById("contactName");
      const contactEmail = document.getElementById("contactEmail");
      const contactMessageEl = document.getElementById("contactMessage");

      // Show message function
      function showMessage(message, type) {
        formMessage.textContent = message;
        formMessage.className = `form-message ${type} show`;
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
          formMessage.classList.remove("show");
        }, 5000);
      }

      // Send button handler
      btnSend.addEventListener("click", async function () {
        const name = contactName.value.trim();
        const email = contactEmail.value.trim();
        const message = contactMessageEl.value.trim();

        // Validation
        if (!name || !email || !message) {
          showMessage("Please fill in all fields", "error");
          return;
        }

        if (name.length < 2) {
          showMessage("Name must be at least 2 characters", "error");
          return;
        }

        if (message.length < 10) {
          showMessage("Message must be at least 10 characters", "error");
          return;
        }

        // Disable buttons during submission
        btnSend.disabled = true;
        btnReset.disabled = true;
        btnSend.textContent = "SENDING...";

        try {
          // Get token from localStorage or cookie
          const token = localStorage.getItem("auth_token") || 
                        document.cookie.split(';').find(c => c.trim().startsWith('auth_token='))
                          ?.split('=')[1];

          if (!token) {
            showMessage("Session expired. Please login again.", "error");
            setTimeout(() => {
              window.location.href = "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
            }, 2000);
            return;
          }

          // IMPORTANT: Use /api/driver/contact for driver pages
          const response = await fetch("/api/driver/contact", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ name, email, message })
          });

          const data = await response.json();

          if (response.ok && data.success) {
            showMessage(data.message, "success");
            // Clear message field only
            contactMessageEl.value = "";
          } else if (response.status === 401 || response.status === 403) {
            showMessage("Session expired. Please login again.", "error");
            setTimeout(() => {
              window.location.href = "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
            }, 2000);
          } else {
            showMessage(data.message || "Failed to send message", "error");
          }
        } catch (error) {
          console.error("Error sending message:", error);
          showMessage("Network error. Please try again.", "error");
        } finally {
          btnSend.disabled = false;
          btnReset.disabled = false;
          btnSend.textContent = "SEND";
        }
      });

      // Reset button handler
      btnReset.addEventListener("click", function () {
        contactMessageEl.value = "";
        formMessage.classList.remove("show");
      });

      // Logout handler
      document.getElementById("logoutBtn").addEventListener("click", async (e) => {
        e.preventDefault();
        try {
          await api.logout();
          localStorage.removeItem("auth_token");
          window.location.href = "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
        } catch (error) {
          console.error("Logout error:", error);
          localStorage.removeItem("auth_token");
          window.location.href = "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
        }
      });

      // Profile dropdown toggle
      const profileBtn = document.getElementById("profileBtn");
      const profileDropdown = document.getElementById("profileDropdown");

      if (profileBtn && profileDropdown) {
        profileBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          profileDropdown.classList.toggle("show");
        });

        document.addEventListener("click", function (e) {
          if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
            profileDropdown.classList.remove("show");
          }
        });
      }

      // Hamburger menu functionality
      const hamburger = document.querySelector(".hamburger");
      const sidebar = document.querySelector(".sidebar");
      const overlay = document.querySelector(".overlay");

      if (hamburger) {
        hamburger.addEventListener("click", function () {
          sidebar.classList.toggle("active");
          overlay.classList.toggle("active");
          if (profileDropdown) {
            profileDropdown.classList.remove("show");
          }
        });
      }

      if (overlay) {
        overlay.addEventListener("click", function () {
          sidebar.classList.remove("active");
          overlay.classList.remove("active");
        });
      }

      const sidebarLinks = document.querySelectorAll(".sidebar a");
      sidebarLinks.forEach((link) => {
        link.addEventListener("click", function () {
          if (window.innerWidth <= 768) {
            sidebar.classList.remove("active");
            overlay.classList.remove("active");
          }
        });
      });
    });
  </script>
</body>

</html>