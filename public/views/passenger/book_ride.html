<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Book Ride</title>
  <link rel="stylesheet" href="/views/passenger/css/passenger.css" />
  <link rel="stylesheet" href="/views/passenger/css/small-screen.css" />
  <link rel="stylesheet" href="/views/passenger/css/large-screen.css" />
  <link rel="icon" type="image/x-icon" href="/views/assets/Logo.png" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>

<body>
  <!-- SIDE NAVIGATION -->
  <div class="sidebar">
    <div class="logo-container">
      <img src="/views/assets/SAKAY BRAVO LOGO_DARK YELLOW.png" class="app-logo" alt="Logo" />
    </div>

    <a href="/passenger/home">Home</a>
    <a class="active" href="/passenger/book-ride">Book Ride</a>
    <a href="/passenger/history">History</a>

    <div class="contact">
      <a href="/passenger/contact" class="contact">Contact Us</a>
    </div>
  </div>

  <!-- TOP NAVIGATION -->
  <header class="top-nav">
    <div class="nav-left">
      <h1 class="nav-title">Book Ride</h1>
      <h2 class="sub-title" id="welcomeMessage">Welcome to Sakay Bravo!</h2>
    </div>
    <div class="nav-right">
      <div class="icon notification">
        <img src="/views/assets/Notification Icon.png" alt="Notifications" />
      </div>
      <div class="profile-dropdown-container">
        <div class="profile" id="profileBtn">
          <img src="/views/assets/Profile Icon.png" alt="Profile" id="profileIcon" />
        </div>
        <!-- Dropdown Menu -->
        <div class="profile-dropdown" id="profileDropdown">
          <div class="dropdown-header">
            <img src="/views/assets/Profile Icon.png" alt="Profile Picture" class="dropdown-profile-pic"
              id="dropdownProfilePic" />
            <div class="dropdown-user-info">
              <h4 id="userName">Loading...</h4>
              <p id="userEmail">Loading...</p>
            </div>
          </div>
          <div class="dropdown-divider"></div>
          <a href="/passenger/profile" class="dropdown-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <span>My Profile</span>
          </a>
          <a href="/passenger/history" class="dropdown-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span>Booking History</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item logout-item" id="logoutBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>Log Out</span>
          </a>
        </div>
      </div>
    </div>
  </header>

  <div class="main-content">
    <!-- Ride Information and Map -->
    <div class="ride-and-map-container">
      <div class="active-ride-tab-container">
        <div class="row">
          <div class="column">
            <div class="content">
              <div class="active-ride-card">
                <div class="firstinfo">
                  <img src="https://randomuser.me/api/portraits/lego/6.jpg" alt="Driver's Profile Picture" />

                  <div class="right-section">
                    <div class="profileinfo">
                      <h1 class="driver-name">Francesco Moustache</h1>
                      <h3 class="driver-occupation">Faculty</h3>
                      <p class="driver-school">
                        School of Accountancy, Management, Computing, and
                        Information Studies
                      </p>
                    </div>

                    <div class="vehicle-box">
                      <span class="vehicle-label">Vehicle</span>
                      <span class="car-model">TOYOTA</span>
                    </div>

                    <div class="rating">
                      <span>â˜…</span><span>â˜…</span><span>â˜…</span><span>â˜…</span><span>â˜†</span>
                    </div>

                    <div class="action-buttons">
                      <button class="button details-btn openDetailsBtn">
                        Driver Details
                      </button>
                      <button class="button book-btn openBookBtn" onclick="openPopup()">
                        Book Ride
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="map-right">
            <div class="map" id="map"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filter and Active Rides -->
    <div class="filter-and-table-container">
      <!-- Filters Section -->
      <div class="filters">
        <div class="filter-left">
          <input type="text" class="filter-search-bar" placeholder="Search by name, role, etc..." />
          <button class="button sort-order-button" id="sortOrderBtn">
            <span class="sort-icon">-</span>
            <span class="sort-text">ASCENDING</span>
          </button>
        </div>
      </div>

      <div class="table-of-rides">
        <table class="rides-information">
          <thead>
            <tr>
              <th>Driver</th>
              <th>Pickup</th>
              <th>Destination</th>
              <th>Available Seats</th>
              <th>Total Seats</th>
              <th>Status</th>
              <th>ETA</th>
            </tr>
          </thead>

          <tbody>
            <tr>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
            </tr>

            <tr>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
            </tr>

            <tr>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
            </tr>

            <tr>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
            </tr>

            <tr>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
              <td>--</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="pagination-container">
        <div class="pagination-info">
          Showing <strong>1</strong> to <strong>5</strong> of
          <strong>120</strong> employees
        </div>

        <div class="pagination-buttons">
          <button class="page-btn">&#8249;</button>
          <button class="page-btn active">1</button>
          <button class="page-btn">2</button>
          <span class="page-dots">...</span>
          <button class="page-btn">24</button>
          <button class="page-btn">&#8250;</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pop up for Ride Confirmation -->
  <div id="payment-popup" class="popup-overlay">
    <div class="popup-container">
      <div class="popup-left">
        <div id="popup-map1"></div>
      </div>

      <div class="popup-right">
        <h1 class="fare">â‚±150</h1>

        <div class="trip-details">
          <p><strong>Destination:</strong> Burnham Park</p>
          <p><strong>Pickup:</strong> SLU Main Gate</p>
          <p><strong>Seats Available:</strong> 9</p>
          <p><strong>Time:</strong> 9:30 AM</p>
          <p><strong>ETA:</strong> 9:55 AM</p>
        </div>

        <div class="popup-buttons">
          <button class="cancel-btn cancel-payment">CANCEL</button>
          <button class="confirm-btn" onclick="openTimerPopup()">
            CONFIRM
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pop up for Timer -->
  <div id="timer-popup" class="popup-overlay">
    <div class="popup-container">
      <div class="timer-container">
        <h3 class="queue-title">Waiting for confirmation...</h3>
        <h1 class="countdown">5:00</h1>

        <div class="popup-buttons">
          <button class="cancel-btn cancel-ride">CANCEL</button>
          <button class="next-btn" onclick="openPaymentOptionsPopup()">
            NEXT
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pop up for Payment Methods -->
  <div id="payment-methods-popup" class="popup-overlay">
    <div class="popup-container">
      <div class="popup-left">
        <div id="popup-map2"></div>
      </div>

      <div class="popup-right">
        <div class="payment-options">
          <h3 class="payment-title">Payment Method</h3>

          <button class="pay-option">GCash</button>
          <button class="pay-option">PayMaya</button>
          <button class="pay-option selected">Cash</button>
        </div>

        <div class="popup-buttons">
          <button class="cancel-btn cancel-methods">CANCEL</button>
          <button class="confirm-btn" onclick="openAcceptedRidePopup()">
            PAY
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pop up for Accepted Ride -->
  <div id="accepted-popup" class="popup-overlay">
    <div class="popup-container">
      <div class="ride-details-container">
        <h3 class="queue-title">Driver is on the way!</h3>

        <div class="active-ride-card-popup">
          <div class="driver-card">
            <div class="driver-left">
              <img src="/views/assets/Profile Icon.png" class="driver-profile-picture" />
            </div>

            <div class="driver-right">
              <h2 class="driver-name">Francesco Moustache</h2>
              <h3 class="driver-occupation">Faculty</h3>
              <p class="driver-school">
                School of Accountancy, Management, Computing, and Information
                Studies
              </p>

              <div class="vehicle-box">
                <span class="vehicle-label">Vehicle</span>
                <span class="car-model">TOYOTA</span>
              </div>

              <div class="plate-number-box">
                <span class="plate-number-label">PLATE NUMBER</span>
                <span class="plate-number">A10Y15</span>
              </div>
            </div>
          </div>
        </div>

        <div class="popup-buttons">
          <button class="cancel-btn cancel-accepted-ride">CANCEL</button>
          <button class="view-btn" onclick="openPickupDetails()">
            VIEW PICK UP DETAILS
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pop up for Pickup Details -->
  <div id="pickup-details-popup" class="popup-overlay">
    <div class="popup-container">
      <div class="popup-left">
        <textarea placeholder="Driver's Message" class="message-area"></textarea>
      </div>

      <div class="popup-right">
        <h1 class="details-title">Pick up Details</h1>

        <div class="trip-details">
          <p><strong>Pickup:</strong> SLU Main Gate</p>
          <p><strong>Pickup Date:</strong> 24-10-15</p>
          <p><strong>Time:</strong> 9:30 AM</p>
          <p><strong>Destination:</strong> Burnham Park</p>
        </div>

        <div class="popup-buttons">
          <button class="back-btn">
            <a href="/passenger/book-ride" class="back-to-dashboard">Back to Dashboard</a>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Load API Service -->
  <script src="/js/api.js"></script>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Profile loading functionality
    document.addEventListener("DOMContentLoaded", async function () {
      console.log("Book Ride page loading...");
      console.log("APIService available:", typeof window.api);

      // Check for token
      const tokenCookie = document.cookie
        .split(";")
        .find((c) => c.trim().startsWith("auth_token="));
      const tokenLocalStorage = localStorage.getItem("auth_token");
      console.log("Token in cookie:", tokenCookie ? "âœ“" : "âœ•");
      console.log("Token in localStorage:", tokenLocalStorage ? "âœ“" : "âœ•");

      // Use the global api instance
      const api = window.api;

      try {
        console.log("Fetching passenger profile...");

        const response = await api.getPassengerProfile();

        if (response.success) {
          const profile = response.data;
          console.log("Profile loaded:", profile);

          // Update welcome message
          document.getElementById(
            "welcomeMessage"
          ).textContent = `Welcome, ${profile.first_name}!`;

          // Update dropdown user info
          document.getElementById(
            "userName"
          ).textContent = `${profile.first_name} ${profile.last_name}`;
          document.getElementById("userEmail").textContent = profile.email;

          // Update profile photos
          if (profile.profile_pic) {
            const photoPath = `/${profile.profile_pic}`;
            console.log("ðŸ“· Profile pic path:", photoPath);

            document.getElementById("profileIcon").src = photoPath;
            document.getElementById("dropdownProfilePic").src = photoPath;
          }
        } else {
          console.error("Failed to load profile:", response);
          alert("Failed to load profile. Please login again.");
          window.location.href =
            "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
        }
      } catch (error) {
        console.error("Error loading profile:", error);
        alert(
          "Authentication error: " + error.message + "\n\nPlease login again."
        );
        window.location.href =
          "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
      }

      // Logout handler
      document
        .getElementById("logoutBtn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          try {
            await api.logout();
            localStorage.removeItem("auth_token");
            window.location.href =
              "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
          } catch (error) {
            console.error("Logout error:", error);
            localStorage.removeItem("auth_token");
            window.location.href =
              "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
          }
        });

      // Profile dropdown toggle
      const profileBtn = document.getElementById("profileBtn");
      const profileDropdown = document.getElementById("profileDropdown");

      if (profileBtn && profileDropdown) {
        profileBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          profileDropdown.classList.toggle("show");
        });

        document.addEventListener("click", function (e) {
          if (
            !profileBtn.contains(e.target) &&
            !profileDropdown.contains(e.target)
          ) {
            profileDropdown.classList.remove("show");
          }
        });
      }
    });

    // Loads map for the Main Page
    var map = L.map("map").setView([16.4023, 120.596], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
    }).addTo(map);

    L.marker([14.5995, 120.9842]).addTo(map);

    // Map popup functions
    function loadMapForPopUp1() {
      const map = L.map("popup-map1").setView([16.4023, 120.596], 13);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
      }).addTo(map);
    }

    function openPopup() {
      document.getElementById("payment-popup").style.display = "flex";
      setTimeout(loadMapForPopUp1, 50);
    }

    function closePopup() {
      document.getElementById("payment-popup").style.display = "none";
    }

    function loadMapForPopUp2() {
      const map = L.map("popup-map2").setView([16.4023, 120.596], 13);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
      }).addTo(map);
    }

    function openPaymentOptionsPopup() {
      document.getElementById("payment-methods-popup").style.display = "flex";
      setTimeout(loadMapForPopUp2, 50);
    }

    function closePaymentOptionsPopup() {
      document.getElementById("payment-methods-popup").style.display = "none";
    }

    function openTimerPopup() {
      document.getElementById("timer-popup").style.display = "flex";
    }

    function closeTimerPopup() {
      document.getElementById("timer-popup").style.display = "none";
    }

    function openAcceptedRidePopup() {
      document.getElementById("accepted-popup").style.display = "flex";
    }

    function closeAcceptedRidePopup() {
      document.getElementById("accepted-popup").style.display = "none";
    }

    function openPickupDetails() {
      document.getElementById("pickup-details-popup").style.display = "flex";
    }

    function closePickupDetails() {
      document.getElementById("pickup-details-popup").style.display = "none";
    }

    document
      .querySelector(".cancel-payment")
      ?.addEventListener("click", closePopup);
    document
      .querySelector(".cancel-methods")
      ?.addEventListener("click", closePaymentOptionsPopup);
    document
      .querySelector(".cancel-ride")
      ?.addEventListener("click", closeTimerPopup);
    document
      .querySelector(".cancel-accepted-ride")
      ?.addEventListener("click", closeAcceptedRidePopup);
  </script>
</body>

</html>