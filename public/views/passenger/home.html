<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SAKAY BRAVO - Passenger Dashboard</title>
    <link rel="stylesheet" href="/views/passenger/css/passenger.css">
    <link rel="stylesheet" href="/views/passenger/css/large-screen.css">
    <link rel="stylesheet" href="/views/passenger/css/small-screen.css">
    <link rel="icon" type="image/x-icon" href="../assets/Logo.png">
</head>
    <link rel="stylesheet" href="/views/passenger/css/passenger.css" />
    <link rel="icon" type="image/x-icon" href="/views/assets/Logo.png" />
  </head>

  <body>
    <!-- SIDE NAVIGATION -->
    <div class="sidebar">
      <div class="logo-container">
        <img
          src="/views/assets/SAKAY BRAVO LOGO_DARK YELLOW.png"
          class="app-logo"
          alt="Logo"
        />
      </div>
      <a class="active" href="/passenger/home">Home</a>
      <a href="/passenger/book-ride">Book Ride</a>
      <a href="/passenger/history">History</a>
      <div class="contact">
        <a href="/passenger/contact" class="contact">Contact Us</a>
      </div>
    </div>

    <!-- TOP NAVIGATION -->
    <header class="top-nav">
      <div class="nav-left">
        <h1 class="nav-title">Home</h1>
        <h2 class="sub-title" id="welcomeMessage">Welcome to Sakay Bravo!</h2>
      </div>
      <div class="nav-right">
        <div class="icon notification">
          <img src="/views/assets/Notification Icon.png" alt="Notifications" />
        </div>
        <div class="profile-dropdown-container">
          <div class="profile" id="profileBtn">
            <img
              src="/views/assets/Profile Icon.png"
              alt="Profile"
              id="profileIcon"
            />
          </div>
          <!-- Dropdown Menu -->
          <div class="profile-dropdown" id="profileDropdown">
            <div class="dropdown-header">
              <img
                src="/views/assets/Profile Icon.png"
                alt="Profile Picture"
                class="dropdown-profile-pic"
                id="dropdownProfilePic"
              />
              <div class="dropdown-user-info">
                <h4 id="userName">Loading...</h4>
                <p id="userEmail">Loading...</p>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <a href="/passenger/profile" class="dropdown-item">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <span>My Profile</span>
            </a>
            <a href="/passenger/history" class="dropdown-item">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <span>Booking History</span>
            </a>
            <div class="dropdown-divider"></div>
            <a href="#" class="dropdown-item logout-item" id="logoutBtn">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              <span>Log Out</span>
            </a>
          </div>
        </div>
      </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <!-- Highlights Section -->
      <section class="highlights-section">
        <div class="section-title">How Can it Help?</div>
        <div class="features-grid">
          <div class="feature-card">
            <div class="feature-image">
              <img src="/views/assets/search.png" alt="Search" />
            </div>
            <h3>SEARCH</h3>
            <p>
              Passengers can look for available rides going to their destination
              within the Maryheights Campus.
            </p>
          </div>
          <div class="feature-card">
            <div class="feature-image">
              <img src="/views/assets/book.png" alt="Book" />
            </div>
            <h3>BOOK</h3>
            <p>
              Passengers can Choose their preferred driver, confirm your seat,
              and get instant updates.
            </p>
          </div>
          <div class="feature-card">
            <div class="feature-image">
              <img src="/views/assets/ride.png" alt="Ride" />
            </div>
            <h3>RIDE</h3>
            <p>
              Passengers get to meet their driver, enjoy the trip, and rate
              their experience for safer future rides.
            </p>
          </div>
        </div>
      </section>
    </main>

    <!-- Load API Service -->
    <script src="/js/api.js"></script>

    <!-- Passenger Profile Script -->
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("Passenger dashboard loading...");
        console.log("APIService available:", typeof window.api);

        // Check for token
        const tokenCookie = document.cookie
          .split(";")
          .find((c) => c.trim().startsWith("auth_token="));
        const tokenLocalStorage = localStorage.getItem("auth_token");
        console.log("Token in cookie:", tokenCookie ? "âœ“" : "âœ•");
        console.log("Token in localStorage:", tokenLocalStorage ? "âœ“" : "âœ•");

        // Use the global api instance
        const api = window.api;

        try {
          console.log("Fetching passenger profile...");

          const response = await api.getPassengerProfile();

          if (response.success) {
            const profile = response.data;
            console.log("Profile loaded:", profile);

            // Update welcome message
            document.getElementById(
              "welcomeMessage"
            ).textContent = `Welcome, ${profile.first_name}!`;

            // Update dropdown user info
            document.getElementById(
              "userName"
            ).textContent = `${profile.first_name} ${profile.last_name}`;
            document.getElementById("userEmail").textContent = profile.email;

            // FIXED: Update profile photos - database already has full path
            if (profile.profile_pic) {
              // Database stores: "uploads/profiles/P001_timestamp.png"
              // Just add leading slash
              const photoPath = `/${profile.profile_pic}`;

              console.log("ðŸ“· Profile pic path:", photoPath);

              document.getElementById("profileIcon").src = photoPath;
              document.getElementById("dropdownProfilePic").src = photoPath;
            }
          } else {
            console.error("Failed to load profile:", response);
            alert("Failed to load profile. Please login again.");
            window.location.href =
              "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
          }
        } catch (error) {
          console.error("Error loading profile:", error);
          alert(
            "Authentication error: " + error.message + "\n\nPlease login again."
          );
          window.location.href =
            "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
        }

        // Logout handler
        document
          .getElementById("logoutBtn")
          .addEventListener("click", async (e) => {
            e.preventDefault();
            try {
              await api.logout();
              localStorage.removeItem("auth_token");
              window.location.href =
                "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
            } catch (error) {
              console.error("Logout error:", error);
              localStorage.removeItem("auth_token");
              window.location.href =
                "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
            }
          });

        // Profile dropdown toggle
        const profileBtn = document.getElementById("profileBtn");
        const profileDropdown = document.getElementById("profileDropdown");

        if (profileBtn && profileDropdown) {
          profileBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            profileDropdown.classList.toggle("show");
          });

          document.addEventListener("click", function (e) {
            if (
              !profileBtn.contains(e.target) &&
              !profileDropdown.contains(e.target)
            ) {
              profileDropdown.classList.remove("show");
            }
          });
        }
      });
    </script>
  </body>
</html>
