<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Booking History</title>
    
    <!-- Fixed CSS paths - use absolute paths -->
    <link rel="stylesheet" href="/views/passenger/css/passenger.css" />
    <link rel="stylesheet" href="/views/passenger/css/large-screen.css">
    <link rel="stylesheet" href="/views/passenger/css/small-screen.css">
    <link rel="icon" type="image/x-icon" href="/views/assets/Logo.png" />
  </head>
  <body>
    <!-- SIDE NAVIGATION -->
    <div class="sidebar">
      <div class="logo-container">
        <img
          src="/views/assets/SAKAY BRAVO LOGO_DARK YELLOW.png"
          class="app-logo"
          alt="Logo"
        />
      </div>

      <a href="/passenger/home">Home</a>
      <a href="/passenger/book-ride">Book Ride</a>
      <a class="active" href="/passenger/history">History</a>

      <div class="contact">
        <a href="/passenger/contact" class="contact">Contact Us</a>
      </div>
    </div>

    <!-- TOP NAVIGATION -->
    <header class="top-nav">
      <div class="nav-left">
        <h1 class="nav-title">Booking History</h1>
        <h2 class="sub-title" id="welcomeMessage">Welcome to Sakay Bravo!</h2>
      </div>
      <div class="nav-right">
        <div class="icon notification">
          <img src="/views/assets/Notification Icon.png" alt="Notifications" />
        </div>
        <div class="profile-dropdown-container">
          <div class="profile" id="profileBtn">
            <img
              src="/views/assets/Profile Icon.png"
              alt="Profile"
              id="profileIcon"
            />
          </div>
          <!-- Dropdown Menu -->
          <div class="profile-dropdown" id="profileDropdown">
            <div class="dropdown-header">
              <img
                src="/views/assets/Profile Icon.png"
                alt="Profile Picture"
                class="dropdown-profile-pic"
                id="dropdownProfilePic"
              />
              <div class="dropdown-user-info">
                <h4 id="userName">Loading...</h4>
                <p id="userEmail">Loading...</p>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <a href="/passenger/profile" class="dropdown-item">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <span>My Profile</span>
            </a>
            <a href="/passenger/history" class="dropdown-item">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <span>Booking History</span>
            </a>
            <div class="dropdown-divider"></div>
            <a href="#" class="dropdown-item logout-item" id="logoutBtn">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              <span>Log Out</span>
            </a>
          </div>
        </div>
      </div>
    </header>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <!-- Statistics Cards -->
      <div class="tabs-container">
        <div class="row">
          <div class="column">
            <div class="card">
              <h3 class="card-header">Rides Taken</h3>
              <p class="number">-</p>
            </div>
          </div>
          <div class="column">
            <div class="card">
              <h3 class="card-header">Total Distance Traveled</h3>
              <p class="number">-</p>
            </div>
          </div>
          <div class="column">
            <div class="card">
              <h3 class="card-header">Total Payment</h3>
              <p class="number">-</p>
            </div>
          </div>
          <div class="column">
            <div class="card">
              <h3 class="card-header">Average Fare</h3>
              <p class="number">-</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters Section -->
      <div class="filters">
        <div class="filter-left">
          <input
            type="text"
            class="filter-search-bar"
            placeholder="Search by name, role, etc..."
          />
          <button class="button sort-order-button" id="sortOrderBtn">
            <span class="sort-icon">â†“</span>
            <span class="sort-text">DESCENDING</span>
          </button>
        </div>
      </div>

      <!-- Transaction Table -->
      <div class="table-of-transactions">
        <table class="transactions-information">
          <thead>
            <tr>
              <th>Reference</th>
              <th>Date</th>
              <th>Pickup</th>
              <th>Dropoff</th>
              <th>Driver</th>
              <th>Status</th>
              <th>Payment</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody>
            <!-- Data will be populated by JavaScript -->
            <tr>
              <td colspan="8" style="text-align: center; padding: 2rem; color: #666;">
                Loading bookings...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="pagination-container">
        <div class="pagination-info">
          Loading...
        </div>

        <div class="pagination-buttons">
          <button class="page-btn">&#8249;</button>
          <button class="page-btn active">1</button>
          <button class="page-btn">&#8250;</button>
        </div>
      </div>
    </div>

    <!-- Load API Service -->
    <script src="/js/api.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("Booking History page loading...");
        console.log("APIService available:", typeof window.api);

        // Check for token
        const tokenCookie = document.cookie
          .split(";")
          .find((c) => c.trim().startsWith("auth_token="));
        const tokenLocalStorage = localStorage.getItem("auth_token");
        console.log("Token in cookie:", tokenCookie ? "âœ“" : "âœ•");
        console.log("Token in localStorage:", tokenLocalStorage ? "âœ“" : "âœ•");

        // Use the global api instance
        const api = window.api;

        try {
          console.log("Fetching passenger profile...");

          const response = await api.getPassengerProfile();

          if (response.success) {
            const profile = response.data;
            console.log("Profile loaded:", profile);

            // Update welcome message
            document.getElementById(
              "welcomeMessage"
            ).textContent = `Welcome, ${profile.first_name}!`;

            // Update dropdown user info
            document.getElementById(
              "userName"
            ).textContent = `${profile.first_name} ${profile.last_name}`;
            document.getElementById("userEmail").textContent = profile.email;

            // Update profile photos
            if (profile.profile_pic) {
              const photoPath = `/${profile.profile_pic}`;
              console.log("ðŸ“· Profile pic path:", photoPath);

              document.getElementById("profileIcon").src = photoPath;
              document.getElementById("dropdownProfilePic").src = photoPath;
            }
          } else {
            console.error("Failed to load profile:", response);
            alert("Failed to load profile. Please login again.");
            window.location.href =
              "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
          }
        } catch (error) {
          console.error("Error loading profile:", error);
          alert(
            "Authentication error: " + error.message + "\n\nPlease login again."
          );
          window.location.href =
            "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
        }

        // Logout handler
        document
          .getElementById("logoutBtn")
          .addEventListener("click", async (e) => {
            e.preventDefault();
            try {
              await api.logout();
              localStorage.removeItem("auth_token");
              window.location.href =
                "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
            } catch (error) {
              console.error("Logout error:", error);
              localStorage.removeItem("auth_token");
              window.location.href =
                "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
            }
          });

        // Profile dropdown toggle
        const profileBtn = document.getElementById("profileBtn");
        const profileDropdown = document.getElementById("profileDropdown");

        if (profileBtn && profileDropdown) {
          profileBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            profileDropdown.classList.toggle("show");
          });

          document.addEventListener("click", function (e) {
            if (
              !profileBtn.contains(e.target) &&
              !profileDropdown.contains(e.target)
            ) {
              profileDropdown.classList.remove("show");
            }
          });
        }

        // Hamburger menu functionality
        const hamburger = document.querySelector(".hamburger");
        const sidebar = document.querySelector(".sidebar");
        const overlay = document.querySelector(".overlay");

        if (hamburger) {
          hamburger.addEventListener("click", function () {
            sidebar.classList.toggle("active");
            overlay.classList.toggle("active");
            if (profileDropdown) {
              profileDropdown.classList.remove("show");
            }
          });
        }

        if (overlay) {
          overlay.addEventListener("click", function () {
            sidebar.classList.remove("active");
            overlay.classList.remove("active");
          });
        }

        const sidebarLinks = document.querySelectorAll(".sidebar a");
        sidebarLinks.forEach((link) => {
          link.addEventListener("click", function () {
            if (window.innerWidth <= 768) {
              sidebar.classList.remove("active");
              overlay.classList.remove("active");
            }
          });
        });
      });
    </script>
    
    <!-- Fixed JS path - use absolute path -->
    <script src="/views/passenger/js/booking_history.js"></script>
  </body>
</html>