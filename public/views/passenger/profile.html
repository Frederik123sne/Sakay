<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Profile</title>
    <link rel="stylesheet" href="css/passenger.css" />
    <link rel="stylesheet" href="css/large-screen.css">
    <link rel="stylesheet" href="css/small-screen.css">
    <link rel="icon" type="image/x-icon" href="../assets/Logo.png" />
    <link rel="stylesheet" href="/views/passenger/css/passenger.css" />
    <link rel="icon" type="image/x-icon" href="/views/assets/Logo.png" />
  </head>
  <body>
    <div class="sidebar">
      <div class="logo-container">
        <img
          src="/views/assets/SAKAY BRAVO LOGO_DARK YELLOW.png"
          class="app-logo"
          alt="Logo"
        />
      </div>

      <a href="/passenger/home">Home</a>
      <a href="/passenger/book-ride">Book Ride</a>
      <a href="/passenger/history">History</a>
      <div class="contact">
        <a href="/passenger/contact">Contact Us</a>
      </div>
    </div>

    <header class="top-nav">
      <div class="nav-left">
        <h1 class="nav-title">Profile</h1>
        <h2 class="sub-title" id="welcomeMessage">Welcome to Sakay Bravo!</h2>
      </div>
      <div class="nav-right">
        <div class="icon notification">
          <img src="/views/assets/Notification Icon.png" alt="Notifications" />
        </div>
        <div class="profile-dropdown-container">
          <div class="profile" id="profileBtn">
            <img
              src="/views/assets/Profile Icon.png"
              alt="Profile"
              id="profileIcon"
            />
          </div>
          <!-- Dropdown Menu -->
          <div class="profile-dropdown" id="profileDropdown">
            <div class="dropdown-header">
              <img
                src="/views/assets/Profile Icon.png"
                alt="Profile Picture"
                class="dropdown-profile-pic"
                id="dropdownProfilePic"
              />
              <div class="dropdown-user-info">
                <h4 id="userName">Loading...</h4>
                <p id="userEmail">Loading...</p>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <a href="/passenger/profile" class="dropdown-item">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <span>My Profile</span>
            </a>
            <a href="/passenger/history" class="dropdown-item">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <span>Booking History</span>
            </a>
            <div class="dropdown-divider"></div>
            <a href="#" class="dropdown-item logout-item" id="logoutBtn">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              <span>Log Out</span>
            </a>
          </div>
        </div>
      </div>
    </header>

    <div class="profile-banner">
      <div class="profile-banner-buttons">
        <div id="editBannerBtn">
          <img
            src="/views/assets/Edit Icon.png"
            width="18"
            alt="edit"
            style="cursor: pointer"
          />
        </div>
        <div>
          <img
            src="/views/assets/Options Icon.png"
            width="18"
            alt="options"
            style="cursor: pointer"
          />
        </div>
      </div>
    </div>

    <div class="profile-wrapper">
      <div class="profile-photo">
        <img
          id="profileImage"
          src="/views/assets/Profile Icon.png"
          alt="Profile Photo"
        />
      </div>

      <div class="profile-details">
        <h2 id="profileName">Loading...</h2>
        <div class="email" id="profileEmail">Loading...</div>
        <div class="joined" id="profileJoined">Joined...</div>
      </div>
    </div>

    <div class="profile-announcement">
      <h3>Announcement from the SakayBravo Admin</h3>
      <p>
        To all users, we want to inform you that we will be having a system
        maintenance tomorrow, <strong>November 18, 2025</strong>, from
        <strong>8:00 AM â€“ 10:00 AM</strong>.
      </p>
    </div>

    <!-- Edit profile Popup -->
    <div id="editPopup" class="popup-overlay">
      <div class="popup-box edit-box">
        <h2>Edit Profile</h2>

        <div class="edit-photo-wrapper">
          <img
            id="editPreview"
            src="/views/assets/Profile Icon.png"
            class="edit-photo"
          />
          <label for="editPhoto" class="camera-icon">
            <img src="/views/assets/Edit Icon.png" />
          </label>
          <input
            type="file"
            id="editPhoto"
            accept="image/*"
            style="display: none"
          />
        </div>

        <label>Name</label>
        <input type="text" id="editName" />

        <label>Mobile Number</label>
        <input type="text" id="editMobile" />

        <button class="save-btn" onclick="saveProfile()">Save</button>
      </div>
    </div>

    <!-- Load API Service -->
    <script src="/js/api.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("Profile page loading...");
        console.log("APIService available:", typeof window.api);

        // Check for token
        const tokenCookie = document.cookie
          .split(";")
          .find((c) => c.trim().startsWith("auth_token="));
        const tokenLocalStorage = localStorage.getItem("auth_token");
        console.log("Token in cookie:", tokenCookie ? "âœ“" : "âœ•");
        console.log("Token in localStorage:", tokenLocalStorage ? "âœ“" : "âœ•");

        // Use the global api instance
        const api = window.api;

        try {
          console.log("Fetching passenger profile...");

          const response = await api.getPassengerProfile();

          if (response.success) {
            const profile = response.data;
            console.log("Profile loaded:", profile);

            // Update welcome message
            document.getElementById(
              "welcomeMessage"
            ).textContent = `Welcome, ${profile.first_name}!`;

            // Update dropdown user info
            document.getElementById(
              "userName"
            ).textContent = `${profile.first_name} ${profile.last_name}`;
            document.getElementById("userEmail").textContent = profile.email;

            // Update main profile info
            document.getElementById(
              "profileName"
            ).textContent = `${profile.first_name} ${profile.last_name}`;
            document.getElementById("profileEmail").textContent = profile.email;

            // Format joined date
            if (profile.created_at) {
              const joinDate = new Date(profile.created_at);
              const options = { year: "numeric", month: "long" };
              document.getElementById(
                "profileJoined"
              ).textContent = `Joined ${joinDate.toLocaleDateString(
                "en-US",
                options
              )}`;
            }

            // Update profile photos
            if (profile.profile_pic) {
              const photoPath = `/${profile.profile_pic}`;
              console.log("ðŸ“· Profile pic path:", photoPath);

              document.getElementById("profileIcon").src = photoPath;
              document.getElementById("dropdownProfilePic").src = photoPath;
              document.getElementById("profileImage").src = photoPath;
              document.getElementById("editPreview").src = photoPath;
            }

            // Pre-fill edit form
            document.getElementById(
              "editName"
            ).value = `${profile.first_name} ${profile.last_name}`;
            if (profile.phone) {
              document.getElementById("editMobile").value = profile.phone;
            }
          } else {
            console.error("Failed to load profile:", response);
            alert("Failed to load profile. Please login again.");
            window.location.href =
              "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
          }
        } catch (error) {
          console.error("Error loading profile:", error);
          alert(
            "Authentication error: " + error.message + "\n\nPlease login again."
          );
          window.location.href =
            "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
        }

        // Logout handler
        document
          .getElementById("logoutBtn")
          .addEventListener("click", async (e) => {
            e.preventDefault();
            try {
              await api.logout();
              localStorage.removeItem("auth_token");
              window.location.href =
                "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
            } catch (error) {
              console.error("Logout error:", error);
              localStorage.removeItem("auth_token");
              window.location.href =
                "http://localhost/Sakaybravo_Webtech_2025_Drainchain_9467/public/auth.php";
            }
          });

        // Profile dropdown toggle
        const profileBtn = document.getElementById("profileBtn");
        const profileDropdown = document.getElementById("profileDropdown");

        if (profileBtn && profileDropdown) {
          profileBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            profileDropdown.classList.toggle("show");
          });

          document.addEventListener("click", function (e) {
            if (
              !profileBtn.contains(e.target) &&
              !profileDropdown.contains(e.target)
            ) {
              profileDropdown.classList.remove("show");
            }
          });
        }

        // Hamburger menu functionality
        const hamburger = document.querySelector(".hamburger");
        const sidebar = document.querySelector(".sidebar");
        const overlay = document.querySelector(".overlay");

        if (hamburger) {
          hamburger.addEventListener("click", function () {
            sidebar.classList.toggle("active");
            overlay.classList.toggle("active");
            if (profileDropdown) {
              profileDropdown.classList.remove("show");
            }
          });
        }

        if (overlay) {
          overlay.addEventListener("click", function () {
            sidebar.classList.remove("active");
            overlay.classList.remove("active");
          });
        }

        const sidebarLinks = document.querySelectorAll(".sidebar a");
        sidebarLinks.forEach((link) => {
          link.addEventListener("click", function () {
            if (window.innerWidth <= 768) {
              sidebar.classList.remove("active");
              overlay.classList.remove("active");
            }
          });
        });
      });

      // Open Edit Popup
      document.getElementById("editBannerBtn").onclick = function () {
        document.getElementById("editPopup").style.display = "flex";
      };

      // Close Edit Popup
      function closeEdit() {
        document.getElementById("editPopup").style.display = "none";
      }

      // Save Profile
      function saveProfile() {
        const newName = document.getElementById("editName").value;
        const newMobile = document.getElementById("editMobile").value;
        const newPhoto = document.getElementById("editPhoto").files[0];

        // Update name
        if (newName) {
          document.getElementById("profileName").textContent = newName;
        }

        // Update photo
        if (newPhoto) {
          const reader = new FileReader();
          reader.onload = function (e) {
            document.getElementById("profileImage").src = e.target.result;
            document.getElementById("profileIcon").src = e.target.result;
            document.getElementById("dropdownProfilePic").src = e.target.result;
          };
          reader.readAsDataURL(newPhoto);
        }

        // If mobile updated (sample only)
        if (newMobile) {
          alert("Mobile Number Updated: " + newMobile);
        }

        closeEdit();
      }

      // Preview photo before save
      document
        .getElementById("editPhoto")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
              document.getElementById("editPreview").src = event.target.result;
            };
            reader.readAsDataURL(file);
          }
        });

      // Close popup when clicking outside
      document
        .getElementById("editPopup")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeEdit();
          }
        });
    </script>
  </body>
</html>
